{% comment %}
Snippet: quote-request-general.liquid
Purpose: Displays a "Request a Quote" button and modal form for truck parts, with separate dropdowns for truck makes and
models.
Usage: Included in product template.
Dependencies: Requires jQuery and Bootstrap for modal functionality.
Notes: Sends product_id instead of variant_id. Uses server URL https://custom-shopify.onrender.com. Validates phone, and new address fields.
{% endcomment %}

<div class="col-item" style="padding: 0 1rem;">
  <a href="#" data-toggle="modal" data-target="#modalQuoteRequest" class="quote-request-btn"
    style="display: block; background-color: #007bff; color: #fff; padding: 0.75rem 1.5rem; text-align: center; border-radius: 0.375rem; font-size: 1.125rem; font-weight: 500; transition: background-color 0.2s; width: 100%; box-sizing: border-box; text-decoration: none;">
    Request a Quote for {{ product.title }}
  </a>
</div>

<!-- Quote Request Modal -->
<div class="modal fade" id="modalQuoteRequest" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 32rem;">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
        <h5 class="modal-title" style="font-size: 1.25rem; font-weight: 600;">Request a Quote for {{ product.title }}
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"
          style="color: #6c757d; font-size: 1.5rem;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <form id="quote-request-form" novalidate style="display: flex; flex-direction: column; gap: 1rem;">
          <!-- Personal Information -->
          <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
            <div class="form-group">
              <label for="quantity"
                style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Quantity</label>
              <input type="number" name="quantity" min="1">
            </div>
            <div class="form-group">
              <label for="quote-first-name"
                style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">First
                Name *</label>
              <input type="text" id="quote-first-name" name="first_name"
                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.2s;"
                required placeholder="Enter your first name">
              <div class="invalid-feedback"
                style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem;">First name is required.
              </div>
            </div>
            <div class="form-group">
              <label for="quote-last-name"
                style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Last
                Name *</label>
              <input type="text" id="quote-last-name" name="last_name"
                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.2s;"
                required placeholder="Enter your last name">
              <div class="invalid-feedback"
                style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem;">Last name is required.
              </div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
            <div class="form-group">
              <label for="quote-email"
                style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Email
                *</label>
              <input type="email" id="quote-email" name="email"
                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.2s;"
                required placeholder="Enter your email">
              <div class="invalid-feedback"
                style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem;">A valid email is
                required.</div>
            </div>
            <div class="form-group">
              <label for="quote-phone"
                style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Phone
                *</label>
              <input type="tel" id="quote-phone" name="phone"
                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.2s;"
                required placeholder="Enter your phone number">
              <div class="invalid-feedback"
                style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem;">Please enter a valid
                phone number (10-15 digits).</div>
            </div>
          </div>
          <!-- Address Information -->
          <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem;">
            <h6 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Address
              Information</h6>
            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
              <div class="form-group">
                <label for="quote-address"
                  style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Address
                  *</label>
                <input type="text" id="quote-address" name="address"
                  style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.2s;"
                  required placeholder="Enter your address">
                <div class="invalid-feedback"
                  style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem;">Address is required.
                </div>
              </div>
              <div class="form-group">
                <label for="quote-state"
                  style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">State
                  *</label>
                <input type="text" id="quote-state" name="state"
                  style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.2s;"
                  required placeholder="Enter your state">
                <div class="invalid-feedback"
                  style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem;">State is required.
                </div>
              </div>
              <div class="form-group">
                <label for="quote-country"
                  style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Country
                  *</label>
                <select id="quote-country" name="country"
                  style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.2s;"
                  required>
                  <option value="" disabled selected>Select a country</option>
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                  <!-- Add more countries as needed -->
                </select>
                <div class="invalid-feedback"
                  style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem;">Country is required.
                </div>
              </div>
            </div>
          </div>
              <div class="form-group">
                <label for="quote-message"
                  style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Message
                  (Optional)</label>
                <textarea id="quote-message" name="message"
                  style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.2s; resize: vertical;"
                  placeholder="Add any additional details or questions"></textarea>
              </div>
          </div>
          <input type="hidden" name="product_title" value="{{ product.title | escape }}">
          <input type="hidden" name="collection_handle" value="{{ target_collection.handle }}">
          <input type="hidden" name="product_id" value="{{ product.id }}">
          <input type="hidden" name="sku" value="{{ product.selected_or_first_available_variant.sku | escape }}">
          <button type="submit" id="quote-submit-btn" class="btn btn-primary"
            style="width: 100%; background-color: #007bff; color: #fff; padding: 0.75rem; border-radius: 0.375rem; font-size: 1rem; font-weight: 500; transition: background-color 0.2s;">
            <span class="btn-text">Submit Quote Request</span>
            <span class="btn-loading" style="display: none;">Submitting...</span>
          </button>
        </form>
        <div id="quote-form-message" style="margin-top: 1rem;"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .quote-request-btn:hover {
    background-color: #0056b3;
    color: #fff;
    text-decoration: none;
  }

  .btn-loading {
    display: inline-block;
    font-size: 0.875rem;
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .is-invalid {
    border-color: #dc3545 !important;
  }

  .is-invalid~.invalid-feedback {
    display: block;
  }

  input:focus,
  select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }

  @media (min-width: 640px) {

    .modal-body>form>div:nth-child(1),
    .modal-body>form>div:nth-child(2),
    .modal-body>form>div:nth-child(4)>div {
      grid-template-columns: 1fr 1fr;
    }
  }
</style>

<script>
  $(function () {

  $('#quote-request-form').on('submit', function (e) {
    e.preventDefault();
    var $form = $(this);
    var $message = $('#quote-form-message');
    var $submitBtn = $('#quote-submit-btn');
    var $btnText = $submitBtn.find('.btn-text');
    var $btnLoading = $submitBtn.find('.btn-loading');
    $message.empty();

    // Client-side validation
    var isValid = true;
    $form.find('input[required], select[required]').each(function () {
      if (!$(this).val()) {
        $(this).addClass('is-invalid');
        isValid = false;
      } else {
        $(this).removeClass('is-invalid');
      }
    });

    // Email validation
    var email = $form.find('#quote-email').val();
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      $form.find('#quote-email').addClass('is-invalid');
      isValid = false;
    }

    // Phone validation
    var phone = $form.find('#quote-phone').val();
    const digitsOnly = phone.replace(/[^0-9]/g, '');
    if (!/^\+?[0-9\s\(\)-]{10,20}$/.test(phone) || digitsOnly.length < 10 || digitsOnly.length > 15) {
      $form.find('#quote-phone').addClass('is-invalid');
      isValid = false;
    } else {
      $form.find('#quote-phone').removeClass('is-invalid');
    }

    // Address validation
    var address = $form.find('#quote-address').val();
    if (address && address.length < 5) {
      $form.find('#quote-address').addClass('is-invalid');
      isValid = false;
    }

    // State validation
    var state = $form.find('#quote-state').val();
    if (state && state.length < 2) {
      $form.find('#quote-state').addClass('is-invalid');
      isValid = false;
    }

    // Country validation
    var country = $form.find('#quote-country').val();
    if (!country) {
      $form.find('#quote-country').addClass('is-invalid');
      isValid = false;
    }

    if (!isValid) {
      $message.html('<div style="color: #dc3545; background-color: #fee2e2; border: 1px solid #f5c2c7; padding: 0.75rem; border-radius: 0.375rem;">Please fill out all required fields correctly.</div>');
      return;
    }

    // Show loading state
    $submitBtn.prop('disabled', true);
    $btnText.hide();
    $btnLoading.show();

    // Prepare form data
    var formData = {
      first_name: $form.find('#quote-first-name').val(),
      last_name: $form.find('#quote-last-name').val(),
      email: email,
      phone: phone,
      product_title: $form.find('input[name="product_title"]').val(),
      collection_handle: $form.find('input[name="collection_handle"]').val(),
      product_id: $form.find('input[name="product_id"]').val(),
      sku: $form.find('input[name="sku"]').val(),
      address: address,
      state: state,
      country: country,
      message: $form.find('#quote-message').val()
    };

    console.log('Submitting Form Data:', JSON.stringify(formData, null, 2));

    // AJAX submission
    $.ajax({
      url: 'https://custom-shopify.onrender.com/api/quote',
      type: 'POST',
      data: JSON.stringify(formData),
      contentType: 'application/json',
      timeout: 60000,
      success: function (response) {
        console.log('Success Response:', response);
        $message.html('<div style="color: #166534; background-color: #dcfce7; border: 1px solid #bbffb3; padding: 0.75rem; border-radius: 0.375rem;">' + (response.message || 'Quote request submitted successfully!') + '</div>');
        $form[0].reset();
        $('.model-dropdown').hide();
        setTimeout(function () {
          $('#modalQuoteRequest').modal('hide');
          $message.empty();
        }, 3000);
      },
      error: function (xhr, status, error) {
        console.error('AJAX Error:', status, error, xhr.responseJSON);
        var errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'An error occurred. Please try again.';
        $message.html('<div style="color: #dc3545; background-color: #fee2e2; border: 1px solid #f5c2c7; padding: 0.75rem; border-radius: 0.375rem;">' + errorMsg + '</div>');
      },
      complete: function () {
        console.log('AJAX Complete');
        $submitBtn.prop('disabled', false);
        $btnText.show();
        $btnLoading.hide();
      }
    });
  });
});
</script>
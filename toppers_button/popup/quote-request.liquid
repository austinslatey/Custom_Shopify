{% comment %}
  Snippet: quote-request.liquid
  Purpose: Displays a "Request a Quote" button and modal form for products in the truck-parts-toppers-truck-caps collection.
  Usage: Included in product template.
  Dependencies: Requires jQuery and Bootstrap for modal functionality.
  Notes: Sends product_id instead of variant_id to match server without variants. Uses new server URL.
{% endcomment %}

<div class="col-item">
  <a href="#" data-toggle="modal" data-target="#modalQuoteRequest" class="btn btn-lg quote-request-btn">
    Request a Quote for {{ product.title }}
  </a>
</div>

<!-- Quote Request Modal -->
<div class="modal fade" id="modalQuoteRequest" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Request a Quote for {{ product.title }}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="quote-request-form" novalidate>
          <div class="form-group">
            <label for="quote-first-name">First Name *</label>
            <input
              type="text"
              id="quote-first-name"
              name="first_name"
              class="form-control"
              required
              placeholder="Enter your first name"
            >
            <div class="invalid-feedback">First name is required.</div>
          </div>
          <div class="form-group">
            <label for="quote-last-name">Last Name *</label>
            <input
              type="text"
              id="quote-last-name"
              name="last_name"
              class="form-control"
              required
              placeholder="Enter your last name"
            >
            <div class="invalid-feedback">Last name is required.</div>
          </div>
          <div class="form-group">
            <label for="quote-email">Email *</label>
            <input
              type="email"
              id="quote-email"
              name="email"
              class="form-control"
              required
              placeholder="Enter your email"
            >
            <div class="invalid-feedback">A valid email is required.</div>
          </div>
          <div class="form-group">
            <label for="quote-phone">Phone *</label>
            <input
              type="tel"
              id="quote-phone"
              name="phone"
              class="form-control"
              required
              placeholder="Enter your phone number"
              pattern="[0-9]{10,15}"
            >
            <div class="invalid-feedback">Please enter a valid phone number (10-15 digits).</div>
          </div>
          <input
            type="hidden"
            name="product_title"
            value="{{ product.title | escape }}"
          >
          <input
            type="hidden"
            name="collection_handle"
            value="{{ target_collection.handle }}"
          >
          <input
            type="hidden"
            name="product_id"
            value="{{ product.id }}"
          >
          <button type="submit" class="btn btn-lg btn-primary" id="quote-submit-btn">
            <span class="btn-text">Submit Quote Request</span>
            <span class="btn-loading" style="display: none;">Loading...</span>
          </button>
        </form>
        <div id="quote-form-message" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .btn-loading {
    display: inline-block;
    font-size: 14px;
  }
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .quote-request-btn {
    background-color: #007bff;
    color: #fff;
    border: none;
    padding: 10px 20px;
    text-align: center;
    display: inline-block;
    width: 100%;
    box-sizing: border-box;
  }
  .quote-request-btn:hover {
    background-color: #0056b3;
    color: #fff;
    text-decoration: none;
  }
  .form-control.is-invalid {
    border-color: #dc3545;
  }
  .invalid-feedback {
    display: none;
    color: #dc3545;
    font-size: 12px;
  }
  .is-invalid ~ .invalid-feedback {
    display: block;
  }
</style>

<script>
  $(function() {
    $('#quote-request-form').on('submit', function(e) {
      e.preventDefault();
      var $form = $(this);
      var $message = $('#quote-form-message');
      var $submitBtn = $('#quote-submit-btn');
      var $btnText = $submitBtn.find('.btn-text');
      var $btnLoading = $submitBtn.find('.btn-loading');
      $message.empty();

      // Client-side validation
      var isValid = true;
      $form.find('input[required]').each(function() {
        if (!$(this).val()) {
          $(this).addClass('is-invalid');
          isValid = false;
        } else {
          $(this).removeClass('is-invalid');
        }
      });
      var email = $form.find('#quote-email').val();
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        $form.find('#quote-email').addClass('is-invalid');
        isValid = false;
      }
      var phone = $form.find('#quote-phone').val();
      if (phone && !/^[0-9]{10,15}$/.test(phone)) {
        $form.find('#quote-phone').addClass('is-invalid');
        isValid = false;
      }

      if (!isValid) {
        $message.html('<div class="alert alert-danger">Please fill out all required fields correctly.</div>');
        return;
      }

      // Show loading state
      $submitBtn.prop('disabled', true);
      $btnText.hide();
      $btnLoading.show();

      // Prepare form data
      var formData = {
        first_name: $form.find('#quote-first-name').val(),
        last_name: $form.find('#quote-last-name').val(),
        email: email,
        phone: phone,
        product_title: $form.find('input[name="product_title"]').val(),
        collection_handle: $form.find('input[name="collection_handle"]').val(),
        product_id: $form.find('input[name="product_id"]').val()
      };

      // AJAX submission to new Render server
      $.ajax({
        url: 'https://custom-shopify.onrender.com/api/quote',
        type: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        success: function(response) {
          $message.html('<div class="alert alert-success">' + (response.message || 'Quote request submitted successfully!') + '</div>');
          $form[0].reset();
          setTimeout(function() {
            $('#modalQuoteRequest').modal('hide');
            $message.empty();
          }, 3000);
        },
        error: function(xhr) {
          var errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'An error occurred. Please try again.';
          $message.html('<div class="alert alert-danger">' + errorMsg + '</div>');
        },
        complete: function() {
          $submitBtn.prop('disabled', false);
          $btnText.show();
          $btnLoading.hide();
        }
      });
    });
  });
</script>